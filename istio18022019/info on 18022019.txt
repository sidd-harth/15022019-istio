add namespace to all istio files
change project names in scriptsssss *****************

try pool ejection with cb config in http and tcp
try cb alone on v2 payment with istio delay

======

add isztio delay to both versions
and use cb rule on both version
then use seige


apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  creationTimestamp: null
  name: payment
  namespace: tutorial
spec:
  host: payment
  subsets:
  - labels:
      app: payment
    name: app-payment
    trafficPolicy:
        connectionPool:
          http:
            http1MaxPendingRequests: 1
            maxRequestsPerConnection: 1
          tcp:
            maxConnections: 1
        outlierDetection:
          baseEjectionTime: 120.000s
          consecutiveErrors: 1
          interval: 1.000s
          maxEjectionPercent: 100


===



while true; do curl movies-apigee.2886795270-80-kitek03.environments.katacoda.com ; sleep .2; done

oc exec -it $(oc get pods|grep payment-v2|awk '{ print $1 }'|head -1) -c payment /bin/bash


siege -r 2 -c 20 -v movies-apigee.2886795268-80-kitek03.environments.katacoda.com

docker push siddharth67/hello:v9
docker run -d -p 8080:80 siddharth67/hello:v9

FOR circuit breaker and showing cocncurrent calls to slow services will get 503,


use 
desti - v1 v2
virtu - v1 50 v2 50
show seige all 200
change dest to sbelow
show seige 503

replace

apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: payment
  namespace: apigee
spec:
  host: payment
  subsets:
    - name: version-v1
      labels:
        version: v1
    - name: version-v2
      labels:
        version: v2
      trafficPolicy:
        connectionPool:
          http:
            http1MaxPendingRequests: 1
            maxRequestsPerConnection: 1
          tcp:
            maxConnections: 1
        outlierDetection:
          baseEjectionTime: 120.000s
          consecutiveErrors: 1
          interval: 1.000s
          maxEjectionPercent: 100





.///////////////////////pool ejection and retry////////////
oc scale deployment payment-v2 --replicas=2 -n apigee

while true; do curl movies-apigee.2886795279-80-kitek03.environments.katacoda.com ; sleep .2; done

apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: payment
  namespace: apigee
spec:
  host: payment
  subsets:
  - labels:
      version: v1
    name: version-v1
  - labels:
      version: v2
    name: version-v2
---

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: payment
  namespace: apigee
spec:
	  hosts:
	  - payment
	  http:
	  - route:
	    - destination:
	        host: payment
	        subset: version-v1
	      weight: 50
	    - destination:
	        host: payment
	        subset: version-v2
	      weight: 50
	---

oc exec -it $(oc get pods|grep payment-v2|awk '{ print $1 }'|head -1) -c payment /bin/bash
curl localhost:8080/misbehave
exit

while true; do curl movies-apigee.2886795279-80-kitek03.environments.katacoda.com ; sleep .2; done

----

replace destination rule

apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  creationTimestamp: null
  name: payment
  namespace: apigee
spec:
  host: payment
  subsets:
  - labels:
      version: v1
    name: version-v1
    trafficPolicy:
      connectionPool:
        http: {}
        tcp: {}
      loadBalancer:
        simple: RANDOM
      outlierDetection:
        baseEjectionTime: 5.000s
        consecutiveErrors: 1
        interval: 5.000s
        maxEjectionPercent: 100
  - labels:
      version: v2
    name: version-v2
    trafficPolicy:
      connectionPool:
        http: {}
        tcp: {}
      loadBalancer:
        simple: RANDOM
      outlierDetection:
        baseEjectionTime: 5.000s
        consecutiveErrors: 1
        interval: 5.000s
        maxEjectionPercent: 100
---


replace virtual service

apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: payment
  namespace: apigee
spec:
  hosts:
  - payment
  http:
  - retries:
      attempts: 3
      perTryTimeout: 4.000s
    route:
    - destination:
        host: payment
        subset: version-v1
      weight: 50
    - destination:
        host: payment
        subset: version-v2
      weight: 50
---







.///////////////////////pool ejection and retry////////////